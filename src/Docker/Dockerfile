# The image of hpcacmbuild.azurecr.io/public/hpcpack/hpcacm/runtime is built using src/Dcoker/Dockerfile-runtime,
# it should be repalced by your own build image.

# allbuild/app is the diretory which stores all applications and its dependencies, 
# we recommend you put the build result under the directory of src/allbuild/app, 
# or under other directoies which you should modify other dockerfiles to get build result. 
# The content of allbuild/app is generated by commands as below:
# cd src/Frontend/Frontend.csproj
# dotnet publish -c Release -o src/allbuild/app/Frontend
# cd src/Bootstrap/Bootstrap.csproj
# donet publish -c Release -o src/allbuild/app/Bootstrap
# cd src/Services/Dashboard/Dashboard.csproj
# donet publish -c Release -o src/allbuild/app/Dashboard
# cd src/Services/JobMonitor/JobMonitor.csproj
# donet publish -c Release -o src/allbuild/app/JobMonitor
# cd src/Services/TaskDispatcher/TaskDispatcher.csproj
# donet publish -c Release -o src/allbuild/app/TaskDispatcher
# cd src/Services/NodeAgent/NodeAgent.csproj
# donet publish -c Release -o src/allbuild/app/NodeAgent

# You could also get allbuild result in docker build environment, but it's not a good practise, the corresponding docker file shows as below:
# FROM microsoft/aspnetcore-build:2.0 AS allbuild
# WORKDIR /src
# COPY *.sln ./
# COPY Frontend/Frontend.csproj Frontend/
# COPY Common/DTO/DTO.csproj Common/DTO/
# COPY Common/Utilities/Utilities.csproj Common/Utilities/
# COPY Services/Common/ServicesCommon.csproj Services/Common/
# COPY Services/JobMonitor/JobMonitor.csproj Services/JobMonitor/
# COPY Services/Dashboard/Dashboard.csproj Services/Dashboard/
# COPY Services/TaskDispatcher/TaskDispatcher.csproj Services/TaskDispatcher/
# COPY Services/NodeAgent/NodeAgent.csproj Services/NodeAgent/
# COPY Bootstrap/Bootstrap.csproj Bootstrap/
# RUN dotnet restore
# COPY . .
# WORKDIR /src/Frontend
# RUN dotnet publish -c Release -o /app/Frontend
# WORKDIR /src/Bootstrap
# RUN dotnet publish -c Release -o /app/Bootstrap
# WORKDIR /src/Services/Dashboard
# RUN dotnet publish -c Release -o /app/Dashboard
# WORKDIR /src/Services/JobMonitor
# RUN dotnet publish -c Release -o /app/JobMonitor
# WORKDIR /src/Services/TaskDispatcher
# RUN dotnet publish -c Release -o /app/TaskDispatcher
# WORKDIR /src/Services/NodeAgent
# RUN dotnet publish -c Release -o /app/NodeAgent
# FROM hpcacmbuild.azurecr.io/public/hpcpack/hpcacm/runtime AS final
# WORKDIR /app/scripts
# COPY Docker/scripts/* ./
# WORKDIR /app
# COPY --from=allbuild /app .
# ENTRYPOINT ["dotnet", "Bootstrap/Bootstrap.dll"]

FROM hpcacmbuild.azurecr.io/public/hpcpack/hpcacm/runtime AS final
WORKDIR /app/scripts
COPY Docker/scripts/* ./
WORKDIR /app
COPY allbuild/app .
ENTRYPOINT ["dotnet", "Bootstrap/Bootstrap.dll"]
