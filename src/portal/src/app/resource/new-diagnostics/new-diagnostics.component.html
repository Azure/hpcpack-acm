<div class="dialog-title" mat-dialog-title>
  <div>
    Run Diagnostics
  </div>
  <div class="close-icon" (click)="close()">
    <i class="material-icons">close</i>
  </div>
</div>

<mat-dialog-content>
  <div *ngIf="errorMessage" class="error-message">
    <i class="material-icons">error_outline</i>
    <div class="error-text">
      {{errorMessage}}
    </div>
  </div>
  <mat-vertical-stepper linear="true" #stepper (selectionChange)="selectionChange($event)">
    <mat-step label="Select test to run">
      <div class="select-tests">
        <tree-root #tree [nodes]="tests" (updateData)="onTreeLoad($event)" class="test-tree">
          <ng-template #treeNodeTemplate let-node let-index="index">
            <mat-checkbox *ngIf="node.children == undefined" (change)="check(node, $event.checked)" [checked]="node.data.checked" color="primary">
              <span>{{node.data.name}}</span>
            </mat-checkbox>
            <span *ngIf="node.children != undefined && node.children.length > 0">{{node.data.name}}</span>
          </ng-template>
        </tree-root>
        <p class="test-description" *ngIf="selectedDescription">
          {{selectedDescription}}
          <a href="{{testInfoLink}}">{{testInfoLink}}</a>
        </p>
      </div>
      <div class="step-btn">
        <button mat-button color="primary" matStepperNext>Next</button>
      </div>
    </mat-step>
    <mat-step label="Set test parameters" optional>
      <div *ngIf="selectedTest == undefined; else testsWithParameters" class="no-params">
        Please select one test in step 1!
      </div>
      <ng-template #testsWithParameters>
        <div *ngIf="selectedTest.parameters == undefined || selectedTest.parameters.length == 0; else showParameters" class="no-params">
          No parameters for the selected tests.
        </div>
        <ng-template #showParameters>
          <div class="name">
            <span>{{selectedTest.name}}</span>
          </div>
          <div class="parameters" *ngFor="let parameter of selectedTest.parameters">
            <mat-form-field>
              <div *ngIf="parameter.options; else noOptions">
                <mat-select [placeholder]="parameter.name" [(ngModel)]="parameter.defaultValue" (ngModelChange)="whenChange($event, parameter, selectedTest)">
                  <mat-option *ngFor="let option of parameter.options" [value]="option">
                    {{option}}
                  </mat-option>
                </mat-select>
              </div>
              <ng-template #noOptions>
                <input matInput [placeholder]="parameter.name" [(ngModel)]="parameter.defaultValue">
              </ng-template>
            </mat-form-field>
          </div>
        </ng-template>
      </ng-template>
      <div class="step-btn">
        <button mat-button color="primary" matStepperPrevious>Back</button>
        <button mat-button color="primary" matStepperNext>Next</button>
      </div>
    </mat-step>
    <mat-step label="Set test name">
      <div>
        <mat-form-field class="diagTestName">
          <input matInput placeholder="Test name" [(ngModel)]='diagTestName' />
        </mat-form-field>
      </div>
      <div class="step-btn last-step">
        <button mat-button color="primary" matStepperPrevious>Back</button>
      </div>
    </mat-step>
  </mat-vertical-stepper>
  <div class="diag-btns">
    <button mat-button color="warn" [mat-dialog-close]="false">Cancel</button>
    <button mat-button color="primary" (click)="getTest()" (keyup.enter)="pressEnter()">Run</button>
  </div>
</mat-dialog-content>